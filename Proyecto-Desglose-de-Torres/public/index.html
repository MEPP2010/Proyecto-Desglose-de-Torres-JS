<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Desglose de Torres</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base con Tailwind, pero ajustando la fuente y el scroll de la tabla */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        /* Fija la cabecera de la tabla para que se mantenga visible al hacer scroll */
        #results-table thead th {
            position: sticky;
            top: 0;
            background-color: #e5e7eb; /* Color de fondo para la cabecera fija */
            z-index: 10;
        }
        /* Estilo para los <select> que coincida con los inputs */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236b7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 0.65em;
            padding-right: 2.5rem; /* Espacio para la flecha */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#004d99',
                        'secondary-blue': '#007bff',
                    },
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto max-w-7xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        
        <div id="title_div" class="flex justify-between items-center mb-6 border-b-2 border-gray-200 pb-2">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-primary-blue">
                Buscador de Desglose de Torres üî©
            </h1>
            <a href='/calculadora' class="bg-indigo-600 text-white hover:bg-indigo-700 transition duration-150 ease-in-out font-semibold py-2 px-4 rounded-lg shadow-md flex items-center whitespace-nowrap text-sm sm:text-base">
                <span class="mr-2 hidden sm:inline">‚û°Ô∏è</span> Ir a Calculadora
            </a>
        </div>
        <form id="search-form">
            <div class="form-row grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                <div class="form-group">
                    <label for="tipo" class="block mb-1 font-semibold text-gray-700">TIPO:</label>
                    <select id="tipo" name="tipo" data-filter-name="TIPO" class="p-2 border border-gray-300 rounded-md w-full focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fabricante" class="block mb-1 font-semibold text-gray-700">FABRICANTE:</label>
                    <select id="fabricante" name="fabricante" data-filter-name="FABRICANTE" class="p-2 border border-gray-300 rounded-md w-full focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cabeza" class="block mb-1 font-semibold text-gray-700">CABEZA:</label>
                    <select id="cabeza" name="cabeza" data-filter-name="CABEZA" class="p-2 border border-gray-300 rounded-md w-full focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parte" class="block mb-1 font-semibold text-gray-700">PARTE (DIVISI√ìN):</label>
                    <select id="parte" name="parte" data-filter-name="PARTE_DIVISION" class="p-2 border border-gray-300 rounded-md w-full focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cuerpo" class="block mb-1 font-semibold text-gray-700">CUERPO:</label>
                    <select id="cuerpo" name="cuerpo" data-filter-name="CUERPO" class="p-2 border border-gray-300 rounded-md w-full focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <!-- NUEVO: Campo TRAMO ahora es un <select> -->
                <div class="form-group">
                    <label for="tramo" class="block mb-1 font-semibold text-gray-700">TRAMO:</label>
                    <select id="tramo" name="tramo" data-filter-name="TRAMO" class="p-2 border border-gray-300 rounded-md w-full focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="w-full sm:w-auto mt-2 py-3 px-6 bg-secondary-blue text-white font-bold rounded-md hover:bg-blue-600 transition duration-200 shadow-lg">
                üîç Buscar Desglose
            </button>
        </form>

        <p id="results-info" class="mt-8 font-semibold text-gray-600">Esperando b√∫squeda... (B√∫squeda exacta activada)</p>
        
        <div class="table-container overflow-x-auto max-h-[60vh] overflow-y-auto mt-4 border border-gray-200 rounded-lg shadow-inner">
            <table id="results-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Material</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Texto Breve</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">TIPO</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">FABRICANTE</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">CABEZA</th> 
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">PARTE(DIVISION)</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">CUERPO</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">TRAMO</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Posici√≥n</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Descripci√≥n</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Long 2</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Cantidad x Torre</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Peso Unitario</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">PLANO</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Mod Plano</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="results-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Array de los IDs de los selectores que participan en el filtrado en cascada
        // MODIFICADO: Incluir 'tramo' en la lista de filtros
        const filterSelects = [
            { id: 'tipo', field: 'TIPO', defaultText: 'Todos los Tipos' },
            { id: 'fabricante', field: 'FABRICANTE', defaultText: 'Todos los Fabricantes' },
            { id: 'cabeza', field: 'CABEZA', defaultText: 'Todas las Cabezas' },
            { id: 'cuerpo', field: 'CUERPO', defaultText: 'Todos los Cuerpos' },
            { id: 'parte', field: 'PARTE_DIVISION', defaultText: 'Todas las Partes' },
            { id: 'tramo', field: 'TRAMO', defaultText: 'Todos los Tramos' } // NUEVO
        ];

        /**
         * Rellena un <select> con opciones, manteniendo la opci√≥n seleccionada si existe
         * y es parte de la nueva lista.
         */
        function populateSelect(selectId, optionList, defaultText) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const selectedValue = select.value;
            
            select.innerHTML = ''; // Limpiar opciones
            
            // A√±adir la opci√≥n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultText;
            select.appendChild(defaultOption);
            
            // Rellenar con la lista de opciones
            let foundSelected = false;
            optionList.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                select.appendChild(option);
                if (optionValue === selectedValue) {
                    foundSelected = true;
                }
            });
            
            // Restaurar el valor seleccionado o volver al valor por defecto
            if (foundSelected) {
                select.value = selectedValue;
            } else {
                select.value = '';
            }
        }

        /**
         * Carga las opciones para los filtros desde la API, aplicando los filtros activos.
         * @param {string} currentFilterId - El ID del filtro que acaba de cambiar (o null en el inicio).
         */
        async function loadFilterOptions(currentFilterId = null) {
            
            // 1. Recoger los valores de los filtros actuales
            const activeFilters = new URLSearchParams();
            filterSelects.forEach(filter => {
                const select = document.getElementById(filter.id);
                if (select && select.value !== '') {
                    activeFilters.append(filter.field, select.value);
                }
            });

            try {
                // 2. Llamar al API con los filtros activos
                const url = `/api/options?${activeFilters.toString()}`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error('Error al cargar opciones');
                
                const data = await response.json();
                
                if (data.success) {
                    const options = data.options;
                    
                    // 3. Rellenar cada select con sus opciones correspondientes
                    filterSelects.forEach(filter => {
                        // Rellenar solo si no es el filtro que acaba de cambiar
                        if (filter.id !== currentFilterId) {
                            populateSelect(filter.id, options[filter.field] || [], filter.defaultText);
                        }
                    });
                } else {
                    console.error('Error de API:', data.message);
                }
            } catch (error) {
                console.error('Error de fetch:', error);
                // Dejar un mensaje de error en los selects si falla
                document.querySelectorAll('select').forEach(sel => sel.innerHTML = '<option value="">Error al cargar</option>');
            }
        }
        
        /**
         * Funci√≥n que se ejecuta al cambiar un filtro.
         * Vuelve a cargar las opciones para todos los dem√°s.
         */
        function reloadFilters(e) {
            const changedSelectId = e.target.id;
            loadFilterOptions(changedSelectId);
        }

        // Cargar las opciones y configurar los listeners cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            loadFilterOptions();
            
            // Configurar el listener de cambio para cada selector
            filterSelects.forEach(filter => {
                const select = document.getElementById(filter.id);
                if (select) {
                    select.addEventListener('change', reloadFilters);
                }
            });
        });

        // --- L√≥gica de b√∫squeda ---
        document.getElementById('search-form').addEventListener('submit', function(e) { 
            e.preventDefault();

            const form = e.target;
            const params = new URLSearchParams();
            
            // Recolecci√≥n de par√°metros (todos desde select ahora)
            params.append('tipo', form.tipo.value);
            params.append('fabricante', form.fabricante.value);
            params.append('cabeza', form.cabeza.value);
            params.append('parte', form.parte.value);
            params.append('cuerpo', form.cuerpo.value);
            params.append('tramo', form.tramo.value); // MODIFICADO: Ahora es un select

            const url = `/api/search?${params.toString()}`;
            const resultsBody = document.getElementById('results-table-body');
            const infoElement = document.getElementById('results-info');
            
            infoElement.textContent = 'Buscando...';
            resultsBody.innerHTML = ''; // Limpiar resultados anteriores

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        infoElement.textContent = `‚úÖ Resultados encontrados: ${data.count} (B√∫squeda exacta)`;
                        
                        data.results.forEach(piece => {
                            const row = resultsBody.insertRow();
                            row.className = "hover:bg-gray-50 transition duration-100";
                            
                            const fields = [
                                'ID_ITEM', 'TEXTO_BREVE_DEL_MATERIAL', 'TIPO', 'FABRICANTE', 'CABEZA', 
                                'PARTE_DIVISION', 'CUERPO', 'TRAMO', 'POSICION', 'DESCRIPCION', 
                                'LONG_2_PRINCIPAL', 'CANTIDAD_X_TORRE', 'PESO_UNITARIO', 'PLANO', 'MOD_PLANO'
                            ];

                            fields.forEach(field => {
                                const cell = row.insertCell();
                                cell.className = "px-6 py-3 whitespace-nowrap text-sm text-gray-800";
                                let value = piece[field] || '-';
                                if (field === 'PESO_UNITARIO') {
                                    const numValue = Number(piece.PESO_UNITARIO);
                                    value = isNaN(numValue) ? '-' : numValue.toFixed(2) + ' kg';
                                }
                                cell.textContent = value;
                            });
                        });

                    } else {
                        infoElement.textContent = `‚ùå Error en la API: ${data.message}`;
                    }
                })
                .catch(error => {
                    infoElement.textContent = `üö® Error de conexi√≥n con el servidor o JSON inv√°lido: ${error.message}`;
                    console.error('Fetch error:', error);
                });
        });
    </script>
</body>
</html>
